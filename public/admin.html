<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - PM Internship Finder</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
/* Your Original CSS */
body {background:#f5f7fb; font-family:'Poppins',sans-serif;}
.sidebar {width:250px; height:100vh; background:#0a326d; color:white; position:fixed; top:0; left:0; padding:20px;}
.sidebar h4 {margin-bottom:30px;}
.sidebar a {color:#b5c7e0; display:block; margin:15px 0; text-decoration:none;}
.sidebar a:hover {color:white;}
.content {margin-left:260px; padding:20px;}
.card {border-radius:16px; box-shadow:0 4px 10px rgba(0,0,0,0.05); text-align: center;} 
.card h5 {font-size: 1rem; color: #555;} 
.card p {margin: 0;} 
.table td, .table th {vertical-align:middle;}
.table-responsive {overflow-x: auto;}
.sidebar a.active {color: white; font-weight: bold;} 
</style>
</head>
<body>

<div class="sidebar">
  <h4><i class="fas fa-user-shield me-2"></i>Admin Panel</h4>
  <a href="index.html"><i class="fas fa-home me-2"></i>Back to Home</a> 
  <a href="#" class="active"><i class="fas fa-briefcase me-2"></i>Manage Internships</a>
  <a href="#manage-users"><i class="fas fa-users me-2"></i>Manage Users</a>
  <a href="#"><i class="fas fa-cog me-2"></i>Settings</a>
</div>

<div class="content">
  <h2 class="mb-4">Internship Management Dashboard</h2>
  
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card p-3">
        <h5><i class="fas fa-briefcase text-primary"></i> Total Internships</h5>
        <p id="totalInterns" class="fs-3 fw-bold">0</p>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <h5><i class="fas fa-user-check text-success"></i> Active Users</h5>
                <p id="activeUsersCount" class="fs-3 fw-bold">0</p>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <h5><i class="fas fa-chart-bar text-warning"></i> Applications Tracked</h5>
        <p id="applicationsTracked" class="fs-3 fw-bold">0</p>
      </div>
    </div>
  </div>

  <div class="card p-4 mb-4">
    <h4>Add New Internship</h4>
    <form id="internForm" class="row g-3">
      <div class="col-md-6">
        <input type="text" class="form-control" id="title" placeholder="Internship Title" required>
      </div>
      <div class="col-md-6">
        <input type="text" class="form-control" id="company" placeholder="Company" required>
      </div>
      <div class="col-md-4">
        <select id="location" class="form-select" required>
          <option value="">Select Location</option>
          <option value="Remote">Remote</option>
          <option value="Delhi">Delhi</option>
          <option value="Mumbai">Mumbai</option>
          <option value="Bangalore">Bangalore</option>
          <option value="Hyderabad">Hyderabad</option>
          <option value="Chennai">Chennai</option>
        </select>
      </div>
      <div class="col-md-4">
        <select id="education" class="form-select" required>
          <option value="">Select Education</option>
          <option value="Diploma">Diploma</option>
          <option value="UG">Undergraduate</option>
          <option value="PG">Postgraduate</option>
        </select>
        </div>
      <div class="col-md-4">
        <input type="text" class="form-control" id="skill" placeholder="Matching Skill (e.g., Coding, Management)" required>
      </div>
      <div class="col-12">
        <input type="url" class="form-control" id="url" placeholder="Application URL (http://example.com/apply)" required>
      </div>
      <div class="col-12">
        <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle me-2"></i>Add Internship</button>
      </div>
    </form>
  </div>

  <div class="card p-4">
    <h4>Current Internship Listings</h4>
    <div class="table-responsive">
      <table class="table table-bordered mt-3 table-striped">
        <thead class="table-dark">
          <tr>
            <th>Title</th>
            <th>Company</th>
            <th>Location</th>
            <th>Education</th>
            <th>Skill</th>
            <th>URL</th>
            <th>Action</th>
          </tr>
          </thead>
          <tbody id="internTable">
            <tr><td colspan="8" class="text-center text-muted">Loading internships...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

     <div id="manage-users" class="card p-4 mt-4">
      <h4>Manage Users</h4>
      <div class="table-responsive">
        <table class="table table-bordered mt-3 table-striped">
          <thead class="table-dark">
            <tr>
              <th>Full Name</th>
              <th>Email</th>
              <th>Role</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr><td colspan="3" class="text-center text-muted">Loading users...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  let internships = []; // Global array to hold data loaded from the server

  // --- SERVER COMMUNICATION FUNCTIONS ---

  /**
   * Loads internship data from the server's persistent storage.
   */
  async function loadInternships() {
      const tableBody = document.getElementById("internTable");
      tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Loading internships...</td></tr>';

      try {
         // Load from Mongo-backed endpoint
        const response = await fetch('/internships'); 
          if (!response.ok) throw new Error('Failed to fetch internship data from the server.');
          
          internships = await response.json();
          renderInternships();
      } catch (error) {
          console.error('Error loading internships:', error);
          tableBody.innerHTML = 
              '<tr><td colspan="8" class="text-center text-danger">Error connecting to server. Is node server.js running and configured correctly?</td></tr>';
      }
  }

  /**
   * Adds a new internship via a POST request to the server.
   */
  document.getElementById("internForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      
    const newInternship = {
        title: document.getElementById("title").value,
        company: document.getElementById("company").value,
        location: document.getElementById("location").value,
        education: document.getElementById("education").value,
        // server expects skills array
        skills: [document.getElementById("skill").value],
        url: document.getElementById("url").value
    };

      try {
         const response = await fetch('/internships/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(newInternship)
        });

          if (response.ok) {
              e.target.reset();
              loadInternships(); // Reload data to show the new entry
          } else {
              alert('Failed to add internship to server.');
          }
      } catch (error) {
          console.error('Error adding internship:', error);
          alert('Server connection error. Could not add internship.');
      }
  });

  /**
   * Removes an internship by sending a DELETE request to the server.
   * @param {string} id - The MongoDB _id of the internship to delete.
   */
  async function removeIntern(id) {
      if (!id) return;
      if (!confirm('Are you sure you want to delete this internship?')) return;
      try {
          const res = await fetch(`/internships/${id}`, { method: 'DELETE' });
          if (!res.ok) {
              const msg = await res.text();
              alert('Delete failed: ' + msg);
              return;
          }
          await loadInternships();
      } catch (e) {
          console.error('Delete error:', e);
          alert('Server error while deleting.');
      }
  }

  // --- CLIENT-SIDE METRIC LOGIC (Uses localStorage) ---

  // Monthly Active Users (MAU) Tracking Logic
  function updateActiveUsers() {
      const currentMonthYear = new Date().toLocaleString('en-us', { month: 'short', year: 'numeric' });
      const currentUserID = localStorage.getItem("currentUserID");
      
      let activeUsersData = JSON.parse(localStorage.getItem('monthlyActiveUsers')) || {};

      if (localStorage.getItem("isLoggedIn") === "true" && currentUserID) {
          if (activeUsersData.month !== currentMonthYear) {
              activeUsersData = { month: currentMonthYear, users: {} };
          }
          activeUsersData.users[currentUserID] = true; 
          localStorage.setItem('monthlyActiveUsers', JSON.stringify(activeUsersData));
      }

      const uniqueActiveCount = activeUsersData.users ? Object.keys(activeUsersData.users).length : 0;
      
      document.getElementById("activeUsersCount").innerText = uniqueActiveCount;
  }

  // Update dashboard counts
  function updateCounts(){
      document.getElementById("totalInterns").innerText = internships.length;
      // Ensure applicationsTracked is initialized in localStorage
      if (!localStorage.getItem("applicationsTracked")) {
          localStorage.setItem("applicationsTracked", 0);
      }
      document.getElementById("applicationsTracked").innerText = localStorage.getItem("applicationsTracked");
  }

  // 4. Render internship list
  function renderInternships(){
      const table = document.getElementById("internTable");
      table.innerHTML = "";
      
      if (internships.length === 0) {
          table.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No internships added yet.</td></tr>';
          updateCounts();
          return;
      }
      
     internships.forEach((intern, index) => {
        const skillsText = Array.isArray(intern.skills) ? intern.skills.join(', ') : (intern.skill || '');
        const row = `<tr>
          <td>${intern.title}</td>
          <td>${intern.company}</td>
          <td>${intern.location}</td>
          <td>${intern.education}</td>
          <td>${skillsText}</td>
          <td><a href="${intern.url}" target="_blank" title="${intern.url}">Link</a></td>
          <td><button class="btn btn-danger btn-sm" onclick="removeIntern('${intern._id}')"><i class="fas fa-trash"></i> Remove</button></td>
        </tr>`;
        table.innerHTML += row;
      });
      updateCounts(); // Update the metrics every time the table is rendered
  }

  // --- USERS MANAGEMENT ---
  async function loadUsers(){
      const tbody = document.getElementById("usersTableBody");
      if (!tbody) return;
      tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Loading users...</td></tr>';
      try{
          const res = await fetch('/users');
          if(!res.ok) throw new Error('Failed to fetch users');
          const users = await res.json();
          renderUsers(users);
      }catch(err){
          tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error loading users</td></tr>';
      }
  }

  function renderUsers(users){
      const tbody = document.getElementById("usersTableBody");
      if (!tbody) return;
      tbody.innerHTML = "";
      if(!users || users.length===0){
          tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No users found.</td></tr>';
          return;
      }
      users.forEach(u=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${u.fullname || ''}</td><td>${u.email || ''}</td><td>${u.role || ''}</td>`;
          tbody.appendChild(tr);
      });
  }

  // --- INITIALIZATION ---
  document.addEventListener("DOMContentLoaded", () => {
      loadInternships(); // Fetches data from the server
      updateActiveUsers(); // Updates MAU count from local storage
      loadUsers();
  });
  </script>
</body>
</html>